---
title: Spring Cloud 微服务（32） --- APM(一) <BR> Sleuth
date: 2019-04-10 21:19:14
updated: 2019-04-10 21:19:14
categories: Java
tags: [SpringCloud, APM]
---

在微服务架构下，服务按照不同的纬度进行拆分，一次请求可能会涉及到多个服务，并且有可能是由不同的团队开发，可能使用不同的编程语言实现，有可能部署在几百台、几千台服务器上，横跨多个不同的数据中心。因此，需要一些可以帮助理解系统行为、分析性能问题的工具，以便在发生故障时，快速定位、解决问题。此类工具称为 `APM`

<!-- more -->

# APM

最出名的 `APM` 是谷歌公开的论文中提到的 `Dapper`。Dapper 对分布式跟踪系统提出了如下需求：
- 性能低损耗：分布式跟踪系统对服务的性能损耗应尽可能做到可以忽略不计，尤其是对性能敏感的应用不能产生损耗。
- 对应用透明：尽可能使用非侵入的方式实现跟踪，尽可能做到业务代码的低侵入，对业务开发人员做到透明化。
- 可伸缩性：是指不能随着微服务和集群规模的扩大而使用分布式跟踪系统瘫痪。
- 跟踪数据可视化、迅速反馈：要有可视化的监控界面，从跟踪数据收集、处理、到结果的展现，尽量做到快速，这样可以对系统的异常状况作出快速反应。
- 持续监控：要求分布式跟踪系统必须是 7X24 小时工作，否则很难定位到系统偶尔抖动的行为。

在 APM 中的一些术语
- Span：基本工作单元。如：发送一次 RPC 请求，就是一个新的 Span。Span 通过一个 64 位的 ID 标识，还包含有描述、事件时间戳、标签、调用它的 Span 的 ID、处理器 ID（一般为 ip 地址）。注意：第一个 Span 是 root Span，它的 ID 和 Trace 的 ID 一样
- Trace：一系列 Span 组成的树状结构，简单的说就是一次调用请求
- Annotation：标注，用来描述事件的实时状态。有如下状态
> cs：Client Sent。客户端发起请求，表示一个 Span 开始
> sr：Server Received。服务方接收到请求，并开始处理，其值减去 cs 时间，就是网络延迟时间
> ss：Server Sent。表示请求处理完成，将响应数据返回给客户端。其值减去 sr 时间，就是服务方处理时间
> cr：Client Received。客户端接收到服务方的返回值，是当前 Span 结束的信号。其值减去 cs，就是一次请求的完整处理时间。

---

# Sleuth

`Sleuth` 是 SpringCloud 的分布式跟踪系统，通过 Trace 定义一次业务调用链，根据它的信息，我们能知道有多少系统参与了该业务处理。而系统间的调用顺序、时间戳信息，通过 Span 记录。Trace 和 Span 整合，就能知道该业务的完整调用链。